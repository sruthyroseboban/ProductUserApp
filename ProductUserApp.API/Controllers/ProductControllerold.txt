using MediatR;
using Microsoft.AspNetCore.Mvc;
using ProductUserApp.Application.Products.Commands.CreateProduct;
using ProductUserApp.Application.Products.Commands.UpdateProduct;
using ProductUserApp.Application.Products.Queries.GetAllProducts;
using ProductUserApp.Application.Products.Commands.DeleteProduct;
using ProductUserApp.Application.Products.Queries.GetProductById;
using ProductUserApp.Application.Products.Queries.GetProductsByUserId;

using Microsoft.AspNetCore.Authorization;
using System.IdentityModel.Tokens.Jwt;

namespace ProductUserApp.API.Controllers;

[Authorize]
[ApiController]
[Route("api/products")]
public class ProductsControllerOld : ControllerBase
{
    private readonly IMediator _mediator;

    public ProductsControllerOld(IMediator mediator)
    {
        _mediator = mediator;
    }

    [HttpPost]
    public async Task<IActionResult> Create(CreateProductCommand command)
    {
        var productId = await _mediator.Send(command);
        return Ok(productId);
    }

    [Authorize(Roles = "Admin")]
    [HttpGet("{userId}")]
    [HttpGet]
    public async Task<IActionResult> GetAll()
    {
        return Ok(await _mediator.Send(new GetAllProductsQuery()));
    }



    //READ PRODUCT BY ID
    [HttpGet("{id}")]
    public async Task<IActionResult> GetById(int id)
            => Ok(await _mediator.Send(new GetProductByIdQuery(id)));

    // READ PRODUCTS BY USER ID
    [HttpGet("user/{userId}")]
    public async Task<IActionResult> GetByUser(int userId)
        => Ok(await _mediator.Send(new GetProductsByUserIdQuery(userId)));



    [HttpPut]
    public async Task<IActionResult> Update(UpdateProductCommand command)
    {
        await _mediator.Send(command);
        return NoContent();
    }

    [HttpDelete("{id}")]
    public async Task<IActionResult> Delete(int id)
    {
        await _mediator.Send(new DeleteProductCommand(id));
        return NoContent();
    }

    [Authorize(Roles = "User")]
    [HttpGet("my-products")]
    public async Task<IActionResult> GetMyProducts()
    {
        var userId = int.Parse(
        User.FindFirst("sub")?.Value ?? "0"
        );

        var products = await _mediator.Send(
            new GetProductsByUserIdQuery(userId)
        );

        return Ok(products);
    }

}
