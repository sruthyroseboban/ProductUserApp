using MediatR;
using ProductService.Application.Common.Interfaces;
using ProductService.Application.Common.Models;
using ProductService.Application.Products.DTOs;

namespace ProductService.Application.Products.Queries.GetProductsByUserId;

public class GetProductsByUserIdQueryHandler : IRequestHandler<GetProductsByUserIdQuery, PagedResult<ProductDto>>
{
    private readonly IProductRepository _repository;

    public GetProductsByUserIdQueryHandler(IProductRepository repository)
    {
        _repository = repository;
    }

    public async Task<PagedResult<ProductDto>> Handle(GetProductsByUserIdQuery request, CancellationToken cancellationToken)
    {
        var pagedResult = await _repository.GetByUserIdPagedAsync(request.UserId, request.PageNumber, request.PageSize);

        return new PagedResult<ProductDto>
        {
            Items = pagedResult.Items.Select(p => new ProductDto
            {
                Id = p.Id,
                Name = p.Name,
                Description = p.Description,
                Price = p.Price,
                DateOfManufacture = p.DateOfManufacture,
                DateOfExpiry = p.DateOfExpiry,
                CreatedByUserId = p.CreatedByUserId,
                ImageUrl = p.ImageUrl
            }).ToList(),
            TotalCount = pagedResult.TotalCount,
            PageNumber = pagedResult.PageNumber,
            PageSize = pagedResult.PageSize
        };
    }
}
