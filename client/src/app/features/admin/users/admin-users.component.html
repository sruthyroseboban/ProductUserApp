<app-layout>
  <!-- Toast notifications -->
  <p-toast></p-toast>

  <!-- Confirmation dialog -->
  <p-confirmDialog></p-confirmDialog>

  <div class="dashboard-container">

    <!-- User Form Card -->
    <p-card [header]="isEditMode ? 'Edit User' : 'Create User'" styleClass="mb-4">
      <div class="form-grid">
        <div class="field">
          <label for="userName">User Name <span class="required">*</span></label>
          <input 
            pInputText 
            id="userName" 
            [(ngModel)]="selectedUser.userName" 
            placeholder="Enter user name"
            class="w-full"
            [disabled]="saving"
            />
        </div>

        <div class="field">
          <label for="email">Email <span class="required">*</span></label>
          <input 
            pInputText 
            id="email" 
            type="email"
            [(ngModel)]="selectedUser.email" 
            placeholder="Enter email"
            class="w-full"
            [disabled]="saving"
             />
        </div>

        <div class="field">
          <label for="password">
            Password 
            <span class="required" *ngIf="!isEditMode">*</span>
            <span style="color: #94a3b8; font-weight: 400;" *ngIf="isEditMode">(Leave blank to keep current)</span>
          </label>
          <p-password 
            id="password"
            [(ngModel)]="userPassword"
            [feedback]="true"
            [toggleMask]="true"
            placeholder="Enter password"
            styleClass="w-full"
            [disabled]="saving">
          </p-password>
          <small style="color: #94a3b8; font-size: 0.85rem;">
            {{ isEditMode ? 'Only fill this if you want to change the password' : 'Minimum 6 characters required' }}
          </small>
        </div>

        <div class="field">
          <label for="role">Role <span class="required">*</span></label>
          <p-select 
            id="role"
            [(ngModel)]="selectedUser.role" 
            [options]="roleOptions" 
            optionLabel="label" 
            optionValue="value"
            placeholder="Select a role"
            class="w-full"
            [disabled]="saving">
          </p-select>
        </div>
        </div>
        <div class="field">
          <!-- Empty div to maintain grid structure -->
          <div class="field flex gap-2 align-items-end">
            <p-button [label]="saving ? 'Saving...' : (isEditMode ? 'Update' : 'Create')"
                      [icon]="saving ? 'pi pi-spin pi-spinner' : 'pi pi-check'"
                      (onClick)="saveUser()"
                      severity="success"
                      [disabled]="saving">
            </p-button>

            <p-button *ngIf="isEditMode"
                      label="Cancel"
                      icon="pi pi-times"
                      (onClick)="resetForm()"
                      severity="secondary"
                      [disabled]="saving">
            </p-button>
          </div>
        </div>
    </p-card>

    <!-- Users Table Card -->
    <p-card header="All Users">
      <!-- Search Bar -->
      <div class="flex justify-content-between mb-3">
        <div class="search-container">
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input pInputText
                   type="text"
                   placeholder="Search by name or email..."
                   [(ngModel)]="searchValue"
                   (input)="onSearch()"
                   style="width: 350px;" />
          </span>
          <button pButton 
                  type="button" 
                  icon="pi pi-times"
                  label="Clear"
                  (click)="clearSearch()"
                  severity="secondary"
                  [outlined]="true"
                  class="ml-2"
                  *ngIf="searchValue">
          </button>
        </div>
        <div class="flex gap-2">
          <button pButton 
                  type="button" 
                  label="Refresh" 
                  icon="pi pi-refresh"
                  (click)="loadUsers()">
          </button>
        </div>
      </div>

      <p-table 
        [value]="filteredUsers" 
        [paginator]="true" 
        [rows]="pageSize"
        [totalRecords]="totalRecords"
        [loading]="loading"
        (onPage)="onPageChange($event)"
        [tableStyle]="{ 'min-width': '50rem' }"
        [rowsPerPageOptions]="[5, 10, 20]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} users"
        styleClass="p-datatable-striped">
        
        <ng-template #header>
          <tr>
            <th pSortableColumn="id">ID <p-sortIcon field="id" /></th>
            <th pSortableColumn="userName">User Name <p-sortIcon field="userName" /></th>
            <th pSortableColumn="email">Email <p-sortIcon field="email" /></th>
            <th pSortableColumn="role">Role <p-sortIcon field="role" /></th>
            <th style="width: 200px">Actions</th>
          </tr>
        </ng-template>
        
        <ng-template #body let-user>
          <tr>
            <td>{{ user.id }}</td>
            <td>{{ user.userName }}</td>
            <td>{{ user.email }}</td>
            <td>
              <span [class]="'badge ' + (user.role === 'Admin' ? 'badge-admin' : 'badge-user')">
                {{ user.role }}
              </span>
            </td>
            <td>
              <div class="flex gap-2">
                <p-button 
                  icon="pi pi-pencil"
                          label="Edit"
                  [rounded]="true"
                  severity="info"
                  size="small"
                  (onClick)="editUser(user)"
                  [text]="true">
                </p-button>
                <p-button 
                  icon="pi pi-trash"
                          label="Delete"
                  [rounded]="true"
                  severity="danger"
                  size="small"
                  (onClick)="deleteUser(user.id!)"
                  [text]="true">
                </p-button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template #emptymessage>
          <tr>
            <td colspan="5" class="text-center">No users found.</td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>

    <!-- Confirmation Dialog -->
    <p-confirmDialog />

  </div>
</app-layout>
